
function run_clean_packages() {
	echo "================== Clean $1 =================="
	cd $1
	# run tools script in package
	./tools clean
	cd ../
}

function run_clean_core() {
	echo "================== Clean core =================="
	cd core
	flutter clean
	flutter pub get
	dart run build_runner build -d
	cd ../
}

function clean(){
	echo "Choose app need to clean:"
	select app in "iportal2" "teacher" "core" "default - all"; do
		case $app in
			iportal2)
				run_clean_packages iportal2
				break
				;;
			teacher)
				run_clean_packages teacher
				break
				;;
			core)
				run_clean_core
				break
				;;
			*)
				run_clean_core
				run_clean_packages iportal2
				run_clean_packages teacher
				break
				;;
		esac
	done
}

function pod_reset_cache() {
	echo "================== Reset pod cache =================="
	echo "Choose app need to reset pod cache:"
	select app in "iportal2" "teacher" "exit"; do
		case $app in
			iportal2)
				cd iportal2
				break
				;;
			teacher)
				cd teacher
				break
				;;
			exit)
				break
				;;
			*)
				echo "Invalid choice."
				;;
		esac
	done
	cd ios
	rm -rf ~/Library/Caches/CocoaPods
	rm -rf Pods
	rm -rf ~/Library/Developer/Xcode/DerivedData/*
	pod deintegrate
	pod setup
	pod install
}

function build_apk() {
	echo "================== Build APK =================="
	echo "Choose app need to build APK (Default: all):"
	select app in "iportal2" "teacher"; do
		case $app in
			iportal2)
				cd iportal2
				break
				;;
			teacher)
				cd teacher
				break
				;;
			*)
				cd iportal2
				cd ../teacher
				cd ../
				break
				;;
		esac
	done
	flutter build apk
	echo "Enter app version:"
	read version
	cp build/app/outputs/flutter-apk/app-release.apk releases/$app-$version.apk
}

function activate_script(){
	cd $1
	chmod +x ./tools
	cd ..
}

function activate_tools_script(){
	echo "================== Activate tools scripts =================="
	echo "Choose app need to activate tools scripts:"
	select app in "iportal2" "teacher" "core"; do
		case $app in
			iportal2)
				activate_script iportal2
				break
				;;
			teacher)
				activate_script teacher
				break
				;;
			core)
				echo "Core does not have tools script. Not implemented yet."
				break
				;;
			*)
				echo "Invalid choice."
				;;
		esac
	done
}

function help() {
	echo """Command line tool for generate code, build, and deploy Flutter apps.
Usage: 
	$ ./tools [Command]

(Note: before running the script, make sure you have the permission to run the script.
To active permission, run: chmod +x ./tools)

or:
	$ bash tools [Command]
	
If no [Command] is passed, the script will run in interactive mode.
	
Commands:
	activate_tools_script:		(No implemented) Activate tools script in a package
	build_apk:			(No implemented) Build APK for a package
	clean:				Clean a package
	reset_pod_cache:		(No implemented) Reset pod cache for a package
	help:				Show this help message
	
In interactive mode, pass the number for choice.
	
Note: Each directory have its own tools script. You can cd to the directory and run ./tools to run the script independently.
"""
}

function main() {
	while true; do
		echo "Running tools scripts (interactive mode)"
		select choice in "Activate tools scripts" "Build APK" "Clean" "Pub gen" "Reset pod cache" "Help" "Exit"; do
			case $choice in
				"Activate tools scripts")
					activate_tools_script
					break
					;;
				"Build APK")
					build_apk
					break
					;;
				"Clean")
					clean
					break
					;;
				"Pub gen")
					clean
					break
					;;
				"Reset pod cache")
					pod_reset_cache
					break
					;;
				"Help")
					help
					;;
				"Exit")
					exit 0
					;;
				*)
					echo "Invalid choice."
					;;
			esac
		done
	done
}

# if no arguments are passed, run the main function
if [ $# -eq 0 ]; then
	main
else
	$@
fi
